pipeline {
    agent any

    tools {
        jdk 'JAVA_HOME'
        maven 'M2_HOME'
    }

    environment {
        PROJECT_DIR = "student-management"
        KUBE_NAMESPACE = "devops"
        KUBE_CONTEXT = "minikube"

        DOCKER_IMAGE = "student-management"
        DOCKER_TAG = "latest"
    }

    stages {

        stage('üì• Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('üèóÔ∏è Build Maven') {
            steps {
                dir("${PROJECT_DIR}") {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('üê≥ Build Docker Image (Minikube)') {
            steps {
                dir("${PROJECT_DIR}") {
                    sh """
                        eval \$(minikube docker-env)
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker images | grep ${DOCKER_IMAGE}
                    """
                }
            }
        }

        stage('‚ò∏Ô∏è Verify Kubernetes') {
            steps {
                sh """
                    kubectl config use-context ${KUBE_CONTEXT}
                    kubectl get ns ${KUBE_NAMESPACE} || kubectl create ns ${KUBE_NAMESPACE}
                """
            }
        }

        stage('üì¶ Deploy Kubernetes Resources') {
            steps {
                sh """
                    kubectl apply -f k8s/ -n ${KUBE_NAMESPACE}
                """
            }
        }

        stage('üîÑ Restart Spring Deployment') {
            steps {
                sh """
                    kubectl rollout restart deployment/student-management -n ${KUBE_NAMESPACE}
                    kubectl rollout status deployment/student-management -n ${KUBE_NAMESPACE} --timeout=5m
                """
            }
        }

        stage('üß™ Verify Deployment') {
            steps {
                sh """
                    kubectl get pods -n ${KUBE_NAMESPACE}
                    kubectl get svc -n ${KUBE_NAMESPACE}
                """
            }
        }

        stage('üåê Application URL') {
            steps {
                sh """
                    MINIKUBE_IP=\$(minikube ip)
                    echo "Application URL: http://\$MINIKUBE_IP:30089"
                """
            }
        }
    }

    post {
        success {
            echo "‚úÖ D√©ploiement r√©ussi"
        }
        failure {
            echo "‚ùå √âchec du d√©ploiement"
            sh """
                kubectl describe pods -n ${KUBE_NAMESPACE}
                kubectl get events -n ${KUBE_NAMESPACE}
            """
        }
        always {
            cleanWs()
        }
    }
}
