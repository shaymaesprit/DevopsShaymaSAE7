pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "spring-boot-app"
        DOCKER_TAG = "${BUILD_NUMBER}"
        KUBE_NAMESPACE = "devops"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '========== Checking out code =========='
                checkout scm
            }
        }
        
        stage('Build with Maven') {
            steps {
                echo '========== Building application with Maven =========='
                sh './mvnw clean package -DskipTests'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo '========== Building Docker image using host Docker =========='
                script {
                    // Use the host Docker daemon (not Minikube's)
                    sh '''
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                        echo "Docker images built successfully"
                        docker images | grep ${DOCKER_IMAGE}
                    '''
                }
            }
        }
        
        stage('Load image into Minikube') {
            steps {
                echo '========== Loading Docker image into Minikube =========='
                sh '''
                    echo "Loading Docker image into Minikube..."
                    minikube image load ${DOCKER_IMAGE}:${DOCKER_TAG}
                    minikube image load ${DOCKER_IMAGE}:latest
                    echo "Image loaded successfully"
                '''
            }
        }
        
        stage('Deploy MySQL') {
            steps {
                echo '========== Deploying MySQL to Kubernetes =========='
                sh '''
                    echo "Creating namespace..."
                    kubectl create namespace ${KUBE_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                    
                    echo "Deploying MySQL..."
                    kubectl apply -f mysql-deployment.yaml
                    
                    echo "Waiting for MySQL to be ready..."
                    kubectl wait --for=condition=ready pod -l app=mysql -n ${KUBE_NAMESPACE} --timeout=300s || true
                    
                    sleep 10
                    echo "MySQL deployment status:"
                    kubectl get pods -n ${KUBE_NAMESPACE} -l app=mysql
                '''
            }
        }
        
        stage('Deploy Spring Boot') {
            steps {
                echo '========== Deploying Spring Boot application =========='
                sh '''
                    echo "Deploying Spring Boot application..."
                    kubectl apply -f spring-deployment.yaml
                    
                    echo "Waiting for Spring Boot pods to be ready..."
                    kubectl wait --for=condition=ready pod -l app=spring-boot-app -n ${KUBE_NAMESPACE} --timeout=300s || true
                    
                    sleep 10
                    echo "Spring Boot deployment status:"
                    kubectl get pods -n ${KUBE_NAMESPACE} -l app=spring-boot-app
                '''
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo '========== Verifying deployment =========='
                sh '''
                    echo "All pods in devops namespace:"
                    kubectl get pods -n ${KUBE_NAMESPACE}
                    
                    echo -e "\nAll services in devops namespace:"
                    kubectl get svc -n ${KUBE_NAMESPACE}
                    
                    echo -e "\nGetting service URL..."
                    SERVICE_URL=$(minikube service spring-service -n ${KUBE_NAMESPACE} --url)
                    echo "Spring Boot application URL: $SERVICE_URL"
                '''
            }
        }
    }
    
    post {
        success {
            echo '========== Pipeline completed successfully =========='
            sh '''
                echo "Deployment Summary:"
                echo "===================="
                kubectl get all -n ${KUBE_NAMESPACE}
                echo ""
                echo "To access the application, run:"
                echo "minikube service spring-service -n devops"
            '''
        }
        failure {
            echo '========== Pipeline failed =========='
            sh '''
                echo "Checking pod logs for errors..."
                kubectl logs -n ${KUBE_NAMESPACE} -l app=spring-boot-app --tail=50 || true
                kubectl logs -n ${KUBE_NAMESPACE} -l app=mysql --tail=50 || true
            '''
        }
    }
}
