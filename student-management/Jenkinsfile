pipeline {
    agent any

    tools {
        jdk 'JAVA_HOME'
        maven 'M2_HOME'
    }

    environment {
        // Docker
        DOCKER_IMAGE = "spring-boot-app"
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_REGISTRY = "your-registry"  // Add your Docker registry

        // Kubernetes
        KUBE_NAMESPACE = "devops"
        KUBE_DEPLOYMENT = "spring-app"
        KUBE_CONTEXT = "minikube"  // Specify Kubernetes context

        // Project
        PROJECT_DIR = "student-management"
        
        // SonarQube
        SONAR_PROJECT_KEY = "student-management"
        SONAR_PROJECT_NAME = "Student-Management"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 1, unit: 'HOURS')
        timestamps()
    }

    stages {
        stage('üì• Checkout Code') {
            steps {
                echo "========== CHECKOUT CODE =========="
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[url: 'https://github.com/shaymaesprit/DevopsShaymaSAE7.git']]
                ])
                sh 'ls -la'
            }
        }

        stage('üèóÔ∏è Build Maven') {
            steps {
                echo "========== BUILD MAVEN =========="
                dir("${PROJECT_DIR}") {
                    sh 'mvn clean package -DskipTests -U'
                }
            }
        }

        stage('üîç SonarQube Analysis') {
            steps {
                echo "========== SONARQUBE ANALYSIS =========="
                dir("${PROJECT_DIR}") {
                    withCredentials([string(credentialsId: 'sonar', variable: 'SONAR_TOKEN')]) {
                        withSonarQubeEnv('sonar') {
                            sh '''
                                mvn sonar:sonar \
                                -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                                -Dsonar.projectName="${SONAR_PROJECT_NAME}" \
                                -Dsonar.sources=src/main \
                                -Dsonar.login=${SONAR_TOKEN}
                            '''
                        }
                    }
                }
            }
        }

        stage('üê≥ Build Docker Image') {
            steps {
                echo "========== BUILD DOCKER IMAGE =========="
                dir("${PROJECT_DIR}") {
                    script {
                        sh '''
                            eval $(minikube docker-env)
                            docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                            docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                            docker images | grep ${DOCKER_IMAGE}
                        '''
                    }
                }
            }
        }

        stage('‚úÖ Verify Kubernetes Access') {
            steps {
                echo "========== VERIFY KUBERNETES ACCESS =========="
                sh '''
                    kubectl config use-context ${KUBE_CONTEXT} || true
                    kubectl cluster-info
                    kubectl get nodes
                    kubectl get namespace ${KUBE_NAMESPACE} || kubectl create namespace ${KUBE_NAMESPACE}
                    kubectl get pods -n ${KUBE_NAMESPACE}
                '''
            }
        }

        stage('üì¶ Deploy MySQL') {
            steps {
                echo "========== DEPLOY MYSQL =========="
                sh '''
                    set -e
                    MYSQL_YAML="${PROJECT_DIR}/../mysql-deployment.yaml"
                    
                    if [ ! -f "$MYSQL_YAML" ]; then
                        echo "‚ùå Error: mysql-deployment.yaml not found at $MYSQL_YAML"
                        echo "Current directory: $(pwd)"
                        echo "Contents of $(dirname $MYSQL_YAML):"
                        ls -la $(dirname $MYSQL_YAML) || true
                        exit 1
                    fi
                    
                    echo "‚úÖ Found mysql-deployment.yaml, applying..."
                    kubectl apply -f $MYSQL_YAML -n ${KUBE_NAMESPACE}
                    
                    echo "Waiting for MySQL deployment to be ready..."
                    kubectl rollout status deployment/mysql-deployment -n ${KUBE_NAMESPACE} --timeout=5m
                    
                    echo "MySQL deployment successful!"
                    sleep 15
                '''
            }
        }

        stage('üöÄ Deploy Spring Boot Application') {
            steps {
                echo "========== DEPLOY SPRING BOOT =========="
                sh '''
                    set -e
                    SPRING_YAML="${PROJECT_DIR}/../spring-deployment.yaml"
                    
                    if [ ! -f "$SPRING_YAML" ]; then
                        echo "‚ùå Error: spring-deployment.yaml not found at $SPRING_YAML"
                        echo "Current directory: $(pwd)"
                        echo "Contents of $(dirname $SPRING_YAML):"
                        ls -la $(dirname $SPRING_YAML) || true
                        exit 1
                    fi
                    
                    echo "‚úÖ Found spring-deployment.yaml, applying..."
                    kubectl apply -f $SPRING_YAML -n ${KUBE_NAMESPACE}
                    
                    echo "Updating image to ${DOCKER_IMAGE}:${DOCKER_TAG}..."
                    kubectl set image deployment/${KUBE_DEPLOYMENT} \
                        spring-app=${DOCKER_IMAGE}:${DOCKER_TAG} \
                        -n ${KUBE_NAMESPACE}
                    
                    echo "Waiting for Spring Boot deployment to be ready..."
                    kubectl rollout status deployment/${KUBE_DEPLOYMENT} -n ${KUBE_NAMESPACE} --timeout=5m
                    
                    echo "Spring Boot deployment successful!"
                '''
            }
        }

        stage('üß™ Post-Deployment Tests') {
            steps {
                echo "========== POST-DEPLOYMENT TESTS =========="
                sh '''
                    sleep 30
                    echo "Pod Status:"
                    kubectl get pods -n ${KUBE_NAMESPACE} -o wide
                    echo ""
                    echo "Service Status:"
                    kubectl get svc -n ${KUBE_NAMESPACE}
                    echo ""
                    echo "Application Logs:"
                    kubectl logs -n ${KUBE_NAMESPACE} -l app=spring-app --tail=50 || echo "No logs available"
                    echo ""
                    echo "MySQL Connectivity Test:"
                    kubectl run -it --rm mysql-test --image=mysql:8.0 --restart=Never \
                        -n ${KUBE_NAMESPACE} -- \
                        mysql -h mysql-service -u appuser -papppassword -D student_db -e "SELECT 1;" || echo "Database test failed"
                '''
            }
        }

        stage('üìä Deployment Report') {
            steps {
                echo "========== DEPLOYMENT REPORT =========="
                sh '''
                    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                    echo "‚ïë      DEPLOYMENT SUMMARY                ‚ïë"
                    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                    echo "Build Number: ${BUILD_NUMBER}"
                    echo "Docker Image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    echo "Kubernetes Namespace: ${KUBE_NAMESPACE}"
                    echo "Deployment Name: ${KUBE_DEPLOYMENT}"
                    echo ""
                    echo "Kubernetes Resources:"
                    kubectl get pods,svc,pvc,configmap,secret -n ${KUBE_NAMESPACE}
                    echo ""
                    echo "Application URL: http://192.168.49.2:30080"
                '''
            }
        }
    }

    post {
        always {
            cleanWs()
            echo "========== CLEANUP =========="
            sh 'docker system prune -f || true'
        }

        success {
            echo "‚úÖ Pipeline executed successfully!"
            echo "‚úÖ Application deployed at: http://192.168.49.2:30080"
        }

        failure {
            echo "‚ùå Pipeline failed!"
            sh '''
                echo "Debug Information:"
                kubectl get events -n ${KUBE_NAMESPACE} --sort-by='.lastTimestamp' | tail -20 || true
                kubectl describe deployment ${KUBE_DEPLOYMENT} -n ${KUBE_NAMESPACE} || true
            '''
        }

        unstable {
            echo "‚ö†Ô∏è Pipeline is unstable"
        }
    }
}
