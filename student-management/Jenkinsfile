pipeline {
    agent any

    tools {
        jdk 'JAVA_HOME'
        maven 'M2_HOME'
    }

    environment {
        DOCKER_IMAGE = "student-management:latest"
        KUBE_NAMESPACE = "devops"
        KUBE_CONTEXT = "minikube"
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'Clonage du repository Git...'
                git branch: 'main',
                    url: 'https://github.com/shaymaesprit/DevopsShaymaSAE7.git'
            }
        }

        stage('Build Maven') {
            steps {
                echo 'Build Maven du projet...'
                dir('student-management') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('SonarQube') {
            steps {
                dir('student-management') {
                    withSonarQubeEnv('sonar') {
                        sh 'mvn sonar:sonar'
                    }
                }
            }
        }

        stage('Build Docker Image (Minikube)') {
            steps {
                dir('student-management') {
                    sh '''
                        eval $(minikube docker-env)
                        docker build -t student-management:latest .
                        docker images | grep student-management
                    '''
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                echo 'Déploiement sur Kubernetes...'
                sh '''
                    kubectl config use-context minikube
                    kubectl get ns devops || kubectl create ns devops

                    kubectl apply -f k8s/ -n devops

                    kubectl rollout restart deployment/student-management -n devops
                    kubectl rollout status deployment/student-management -n devops
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                sh '''
                    kubectl get pods -n devops
                    kubectl get svc -n devops
                '''
            }
        }

        stage('Application URL') {
            steps {
                sh '''
                    MINIKUBE_IP=$(minikube ip)
                    echo "Application disponible sur : http://$MINIKUBE_IP:30089"
                '''
            }
        }
    }

    post {
        success {
            echo 'Pipeline terminé avec succès'
        }
        failure {
            echo 'Pipeline échoué'
            sh '''
                kubectl describe pods -n devops
                kubectl get events -n devops
            '''
        }
        always {
            cleanWs()
        }
    }
}
