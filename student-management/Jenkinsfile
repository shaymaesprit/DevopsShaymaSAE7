pipeline {
    agent any

    tools {
        jdk 'JAVA_HOME'
        maven 'M2_HOME'
    }

    environment {
        // Project
        PROJECT_DIR = "student-management"
        WORKSPACE_ROOT = "${WORKSPACE}"
        
        // Docker
        DOCKER_IMAGE = "student-management"
        DOCKER_TAG = "${BUILD_NUMBER}"
        
        // Kubernetes
        KUBE_NAMESPACE = "devops"
        KUBE_DEPLOYMENT = "student-management"
        KUBE_CONTEXT = "minikube"
        
        // SonarQube
        SONAR_PROJECT_KEY = "student-management"
        SONAR_PROJECT_NAME = "Student-Management"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 2, unit: 'HOURS')
        timestamps()
    }

    stages {

        stage('üì• Checkout Code') {
            steps {
                echo "========== CHECKOUT CODE =========="
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[url: 'https://github.com/shaymaesprit/DevopsShaymaSAE7.git']]
                ])
                sh 'echo "Repository cloned successfully"'
            }
        }

        stage('üîç Verify Files') {
            steps {
                echo "========== VERIFY PROJECT FILES =========="
                sh """
                    echo "Current directory: \$(pwd)"
                    echo ""
                    echo "Project directory structure:"
                    ls -la ${PROJECT_DIR}/
                    echo ""
                    echo "Checking required files..."
                    [ -f "${PROJECT_DIR}/Dockerfile" ] && echo "‚úÖ Dockerfile found" || (echo "‚ùå Dockerfile not found!"; exit 1)
                    [ -f "${PROJECT_DIR}/pom.xml" ] && echo "‚úÖ pom.xml found" || (echo "‚ùå pom.xml not found!"; exit 1)
                    [ -f "${PROJECT_DIR}/kubernetes/mysql-deployment.yaml" ] && echo "‚úÖ mysql-deployment.yaml found" || (echo "‚ùå mysql-deployment.yaml not found!"; exit 1)
                    [ -f "${PROJECT_DIR}/kubernetes/spring-deployment.yaml" ] && echo "‚úÖ spring-deployment.yaml found" || (echo "‚ùå spring-deployment.yaml not found!"; exit 1)
                """
            }
        }

        stage('üèóÔ∏è Build Maven') {
            steps {
                echo "========== BUILDING WITH MAVEN =========="
                dir("${PROJECT_DIR}") {
                    sh '''
                        echo "Building project in: $(pwd)"
                        chmod +x mvnw
                        ./mvnw clean package -DskipTests -U
                        echo "‚úÖ Maven build completed"
                    '''
                }
            }
        }

        stage('‚úÖ Run Unit Tests') {
            steps {
                echo "========== RUNNING TESTS =========="
                dir("${PROJECT_DIR}") {
                    sh '''
                        echo "Running unit tests..."
                        ./mvnw test
                        echo "‚úÖ Tests completed"
                    '''
                }
            }
        }

        stage('üîç SonarQube Analysis') {
            when {
                environment name: 'SKIP_SONAR', value: 'false'
            }
            steps {
                echo "========== SONARQUBE ANALYSIS =========="
                dir("${PROJECT_DIR}") {
                    script {
                        try {
                            withCredentials([string(credentialsId: 'sonar', variable: 'SONAR_TOKEN')]) {
                                sh '''
                                    echo "Running SonarQube analysis..."
                                    ./mvnw sonar:sonar \
                                        -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                                        -Dsonar.projectName="${SONAR_PROJECT_NAME}" \
                                        -Dsonar.sources=src/main \
                                        -Dsonar.login=${SONAR_TOKEN} \
                                        -Dsonar.host.url=http://localhost:9000 \
                                        -Dsonar.qualitygate.wait=true || echo "‚ö†Ô∏è  SonarQube analysis skipped"
                                '''
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è  SonarQube not available, continuing pipeline"
                        }
                    }
                }
            }
        }

        stage('üê≥ Build Docker Image') {
            steps {
                echo "========== BUILD DOCKER IMAGE =========="
                dir("${PROJECT_DIR}") {
                    sh '''
                        echo "Building Docker image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                        echo "‚úÖ Docker image built successfully"
                        docker images | grep ${DOCKER_IMAGE}
                    '''
                }
            }
        }

        stage('üì¶ Load Image to Minikube') {
            steps {
                echo "========== LOAD IMAGE TO MINIKUBE =========="
                sh '''
                    echo "Loading image into minikube: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    minikube image load ${DOCKER_IMAGE}:${DOCKER_TAG}
                    echo "‚úÖ Image loaded to minikube"
                    minikube image ls | grep ${DOCKER_IMAGE}
                '''
            }
        }

        stage('‚úÖ Verify Kubernetes Access') {
            steps {
                echo "========== VERIFY KUBERNETES CLUSTER =========="
                sh '''
                    echo "Using Kubernetes context: ${KUBE_CONTEXT}"
                    kubectl config use-context ${KUBE_CONTEXT} || true
                    
                    echo ""
                    echo "Cluster info:"
                    kubectl cluster-info
                    
                    echo ""
                    echo "Nodes:"
                    kubectl get nodes
                    
                    echo ""
                    echo "Creating/Verifying namespace: ${KUBE_NAMESPACE}"
                    kubectl create namespace ${KUBE_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                    
                    echo "‚úÖ Kubernetes access verified"
                '''
            }
        }

        stage('üìÇ Create PV Directory') {
            steps {
                echo "========== CREATE PERSISTENT VOLUME DIRECTORY =========="
                sh '''
                    echo "Creating MySQL data directory on minikube..."
                    minikube ssh "sudo mkdir -p /data/mysql && sudo chmod 777 /data/mysql" || true
                    echo "‚úÖ Directory created"
                '''
            }
        }

        stage('üì¶ Deploy MySQL') {
            steps {
                echo "========== DEPLOYING MYSQL =========="
                sh '''
                    MYSQL_YAML="${WORKSPACE_ROOT}/${PROJECT_DIR}/kubernetes/mysql-deployment.yaml"
                    
                    if [ ! -f "$MYSQL_YAML" ]; then
                        echo "‚ùå MySQL deployment file not found at: $MYSQL_YAML"
                        exit 1
                    fi
                    
                    echo "Applying MySQL deployment from: $MYSQL_YAML"
                    kubectl apply -f $MYSQL_YAML
                    
                    echo ""
                    echo "Waiting for MySQL to be ready (30 seconds)..."
                    sleep 30
                    
                    echo ""
                    echo "MySQL deployment status:"
                    kubectl get pods -n ${KUBE_NAMESPACE} -l app=mysql
                    
                    echo "‚úÖ MySQL deployed"
                '''
            }
        }

        stage('üöÄ Deploy Spring Boot Application') {
            steps {
                echo "========== DEPLOYING SPRING BOOT APPLICATION =========="
                sh '''
                    SPRING_YAML="${WORKSPACE_ROOT}/${PROJECT_DIR}/kubernetes/spring-deployment.yaml"
                    
                    if [ ! -f "$SPRING_YAML" ]; then
                        echo "‚ùå Spring deployment file not found at: $SPRING_YAML"
                        exit 1
                    fi
                    
                    echo "Applying Spring Boot deployment from: $SPRING_YAML"
                    kubectl apply -f $SPRING_YAML
                    
                    echo ""
                    echo "Waiting for Spring Boot to be ready (15 seconds)..."
                    sleep 15
                    
                    echo ""
                    echo "Spring Boot deployment status:"
                    kubectl get pods -n ${KUBE_NAMESPACE} -l app=student-management
                    
                    echo ""
                    echo "Waiting for deployment to roll out..."
                    kubectl rollout status deployment/${KUBE_DEPLOYMENT} -n ${KUBE_NAMESPACE} --timeout=5m || true
                    
                    echo "‚úÖ Spring Boot deployed"
                '''
            }
        }

        stage('üîç Verify Deployments') {
            steps {
                echo "========== VERIFYING DEPLOYMENTS =========="
                sh '''
                    echo "=== All Pods in ${KUBE_NAMESPACE} namespace ==="
                    kubectl get pods -n ${KUBE_NAMESPACE} -o wide
                    
                    echo ""
                    echo "=== All Services in ${KUBE_NAMESPACE} namespace ==="
                    kubectl get svc -n ${KUBE_NAMESPACE}
                    
                    echo ""
                    echo "=== All Deployments in ${KUBE_NAMESPACE} namespace ==="
                    kubectl get deployments -n ${KUBE_NAMESPACE}
                    
                    echo ""
                    echo "=== PersistentVolumeClaims ==="
                    kubectl get pvc -n ${KUBE_NAMESPACE}
                    
                    echo ""
                    echo "‚úÖ Deployments verified"
                '''
            }
        }

        stage('üìã View Application Logs') {
            steps {
                echo "========== APPLICATION LOGS =========="
                sh '''
                    echo "=== MySQL Logs (last 30 lines) ==="
                    kubectl logs deployment/mysql -n ${KUBE_NAMESPACE} --tail=30 || echo "‚ö†Ô∏è  No MySQL logs available yet"
                    
                    echo ""
                    echo "=== Spring Boot Logs (last 50 lines) ==="
                    kubectl logs deployment/${KUBE_DEPLOYMENT} -n ${KUBE_NAMESPACE} --tail=50 || echo "‚ö†Ô∏è  No Spring logs available yet"
                    
                    echo ""
                    echo "‚úÖ Logs displayed"
                '''
            }
        }

        stage('üß™ Health Check') {
            steps {
                echo "========== HEALTH CHECKS =========="
                sh '''
                    echo "Waiting 10 seconds for services to stabilize..."
                    sleep 10
                    
                    echo ""
                    echo "Getting Spring Boot pod name..."
                    POD_NAME=$(kubectl get pod -n ${KUBE_NAMESPACE} -l app=student-management -o jsonpath='{.items[0].metadata.name}')
                    
                    if [ -z "$POD_NAME" ]; then
                        echo "‚ö†Ô∏è  No Spring Boot pod found yet"
                    else
                        echo "Found pod: $POD_NAME"
                        
                        echo ""
                        echo "Testing Spring Boot endpoint..."
                        kubectl exec -it $POD_NAME -n ${KUBE_NAMESPACE} -- curl -s http://localhost:8080/actuator/health || echo "‚ö†Ô∏è  Endpoint not responding"
                    fi
                    
                    echo ""
                    echo "‚úÖ Health checks completed"
                '''
            }
        }

        stage('üìä Deployment Report') {
            steps {
                echo "========== DEPLOYMENT REPORT =========="
                sh '''
                    echo "=========================================="
                    echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY"
                    echo "=========================================="
                    echo ""
                    echo "Project: Student Management"
                    echo "Namespace: ${KUBE_NAMESPACE}"
                    echo "Docker Image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    echo ""
                    
                    MINIKUBE_IP=$(minikube ip)
                    echo "Application Details:"
                    echo "  URL: http://${MINIKUBE_IP}:30080"
                    echo "  Service: student-service"
                    echo "  Replicas: 2 (Spring Boot)"
                    echo "  Database: MySQL 8.0"
                    echo ""
                    
                    echo "To access your application:"
                    echo "  1. minikube service student-service -n devops --url"
                    echo "  2. Or directly: curl http://${MINIKUBE_IP}:30080/actuator/health"
                    echo ""
                    echo "To view logs:"
                    echo "  kubectl logs -f deployment/student-management -n devops"
                    echo ""
                    echo "To access pod shell:"
                    echo "  kubectl exec -it <pod-name> -n devops -- bash"
                    echo ""
                    echo "=========================================="
                '''
            }
        }
    }

    post {
        always {
            echo "========== PIPELINE CLEANUP =========="
            sh '''
                echo "Cleaning up workspace..."
                docker system prune -f || true
            '''
        }

        success {
            echo "‚úÖ Pipeline executed successfully!"
            echo "Your application is now deployed on Kubernetes!"
        }

        failure {
            echo "‚ùå Pipeline failed! Debugging information below:"
            sh '''
                echo "=== Recent Events in ${KUBE_NAMESPACE} namespace ==="
                kubectl get events -n ${KUBE_NAMESPACE} --sort-by='.lastTimestamp' | tail -20 || true
                
                echo ""
                echo "=== Pod Status ==="
                kubectl describe pod -n ${KUBE_NAMESPACE} || true
                
                echo ""
                echo "=== Deployment Status ==="
                kubectl describe deployment ${KUBE_DEPLOYMENT} -n ${KUBE_NAMESPACE} || true
                kubectl describe deployment mysql -n ${KUBE_NAMESPACE} || true
            '''
        }
    }
}
