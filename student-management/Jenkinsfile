pipeline {
    agent any

    tools {
        jdk 'JAVA_HOME'
        maven 'M2_HOME'
    }

    environment {
        PROJECT_DIR = "student-management"
        KUBE_NAMESPACE = "devops"
        DOCKER_IMAGE = "student-management"
        DOCKER_TAG = "latest"
    }

    stages {

        stage('üì• Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('üèóÔ∏è Build Maven') {
            steps {
                dir("${PROJECT_DIR}") {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('üîç Verify Minikube') {
            steps {
                sh """
                    echo "Checking Minikube status..."
                    minikube status || (echo "Minikube not running!" && exit 1)
                    
                    echo "Verifying kubectl connection..."
                    kubectl config use-context minikube
                    kubectl cluster-info
                    kubectl get nodes
                """
            }
        }

        stage('üê≥ Build Docker Image (Minikube)') {
            steps {
                dir("${PROJECT_DIR}") {
                    sh """
                        echo "Configuring Docker to use Minikube daemon..."
                        eval \$(minikube docker-env --shell bash)
                        
                        echo "Building Docker image..."
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        
                        echo "Verifying image was built..."
                        docker images | grep ${DOCKER_IMAGE}
                    """
                }
            }
        }

        stage('üì¶ Deploy Kubernetes Resources') {
            steps {
                sh """
                    echo "Deploying to namespace: ${KUBE_NAMESPACE}"
                    kubectl apply -f k8s/ -n ${KUBE_NAMESPACE}
                """
            }
        }

        stage('üîÑ Restart Spring Deployment') {
            steps {
                sh """
                    kubectl rollout restart deployment/student-management -n ${KUBE_NAMESPACE}
                    kubectl rollout status deployment/student-management -n ${KUBE_NAMESPACE} --timeout=5m
                """
            }
        }

        stage('üß™ Verify Deployment') {
            steps {
                sh """
                    echo "Pods in namespace ${KUBE_NAMESPACE}:"
                    kubectl get pods -n ${KUBE_NAMESPACE}
                    
                    echo "Services in namespace ${KUBE_NAMESPACE}:"
                    kubectl get svc -n ${KUBE_NAMESPACE}
                """
            }
        }

        stage('üåê Application URL') {
            steps {
                script {
                    def minikubeIp = sh(script: 'minikube ip', returnStdout: true).trim()
                    echo "‚úÖ Application URL: http://${minikubeIp}: 30089"
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ D√©ploiement r√©ussi!"
        }
        failure {
            echo "‚ùå √âchec du d√©ploiement"
            sh """
                echo "=== Pod Details ==="
                kubectl describe pods -n ${KUBE_NAMESPACE} || echo "Cannot connect to cluster"
                
                echo "=== Recent Events ==="
                kubectl get events -n ${KUBE_NAMESPACE} --sort-by='. lastTimestamp' || echo "Cannot get events"
                
                echo "=== Minikube Status ==="
                minikube status || echo "Minikube not accessible"
            """
        }
        always {
            cleanWs()
        }
    }
}
